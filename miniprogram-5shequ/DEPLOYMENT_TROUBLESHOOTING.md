# 部署问题排查指南

## 🚨 当前问题：构建成功但部署失败

### 问题描述
- ✅ 构建阶段：成功
- ❌ 部署阶段：健康检查失败
- 错误：`connection refused on port 3000`

### 🔍 问题分析

#### 可能原因
1. **应用启动失败** - 代码错误导致应用崩溃
2. **端口监听问题** - 应用未正确监听端口 3000
3. **依赖问题** - 缺少必要的依赖包
4. **权限问题** - 文件权限或用户权限问题
5. **环境变量问题** - 环境配置错误

#### 排查步骤

### 步骤 1：检查容器日志
在腾讯云控制台查看容器日志：
1. 进入云托管服务
2. 点击"版本管理"
3. 查看最新版本的日志
4. 寻找错误信息和启动日志

### 步骤 2：使用简化版服务器测试
如果主服务器有问题，可以临时使用简化版：

```bash
# 在腾讯云控制台修改 Dockerfile 路径为：
Dockerfile.simple
```

### 步骤 3：本地测试
在本地测试应用是否能正常启动：

```bash
# 安装依赖
npm install

# 测试主服务器
node server.js

# 测试简化版服务器
node server-simple.js
```

### 步骤 4：检查依赖
确保所有必要的依赖都已安装：

```json
{
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "body-parser": "^1.20.2"
  }
}
```

### 步骤 5：检查云函数模块
确保所有云函数模块都能正常导入：

```bash
# 测试各个模块
node -e "console.log('Testing modules...'); require('./cloudfunctions/home/index.js'); console.log('home OK');"
node -e "console.log('Testing modules...'); require('./cloudfunctions/user/index.js'); console.log('user OK');"
# ... 其他模块
```

## 🛠️ 解决方案

### 方案一：使用简化版服务器（推荐）
1. 在腾讯云控制台修改 Dockerfile 路径为 `Dockerfile.simple`
2. 重新部署
3. 验证服务是否正常启动

### 方案二：修复主服务器
1. 检查 `server.js` 中的模块导入
2. 确保所有云函数模块存在且可导入
3. 添加错误处理和日志

### 方案三：分步部署
1. 先部署简化版确认基础环境正常
2. 逐步添加云函数模块
3. 最终切换到完整版服务器

## 📋 检查清单

### 部署前检查
- [ ] 所有文件已提交到 Git
- [ ] Dockerfile 路径正确
- [ ] 端口配置为 3000
- [ ] 健康检查端点可用

### 部署后检查
- [ ] 构建日志无错误
- [ ] 容器启动日志正常
- [ ] 健康检查通过
- [ ] API 端点可访问

## 🔧 常用命令

### 本地测试
```bash
# 构建镜像
docker build -f Dockerfile.simple -t test-app .

# 运行容器
docker run -p 3000:3000 test-app

# 测试健康检查
curl http://localhost:3000/health
```

### 腾讯云部署
```bash
# 查看部署状态
# 在腾讯云控制台查看

# 查看日志
# 在版本管理中查看详细日志
```

## 📞 获取帮助

如果问题仍然存在：
1. 查看完整的容器日志
2. 检查云函数模块的依赖
3. 验证网络配置
4. 联系腾讯云技术支持

## 🎯 成功标志

部署成功的标志：
- ✅ 构建状态：成功
- ✅ 部署状态：运行中
- ✅ 健康检查：通过
- ✅ API 访问：正常
- ✅ 日志输出：无错误 